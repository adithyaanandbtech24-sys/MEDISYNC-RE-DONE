rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns this file path
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Validate file size (max 10MB)
    function isValidSize() {
      return request.resource.size <= 10485760; // 10MB
    }
    
    // Validate file type (PDF, JPEG, PNG only)
    function isValidFileType() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('image/jpeg') ||
             request.resource.contentType.matches('image/jpg') ||
             request.resource.contentType.matches('image/png');
    }
    
    // Check if user is a family member (requires Firestore lookup)
    function isFamilyMember(patientUid) {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/users/$(patientUid)/family/$(request.auth.uid));
    }
    
    // Check if user is a provider (requires Firestore lookup)
    function isProvider(patientUid) {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/providers/$(request.auth.uid)/patients/$(patientUid));
    }
    
    // Check read access (owner, family, or provider)
    function canRead(uid) {
      return isOwner(uid) || isFamilyMember(uid) || isProvider(uid);
    }
    
    // Check write access (owner or provider only)
    function canWrite(uid) {
      return isOwner(uid) || isProvider(uid);
    }
    
    // ============================================================
    // USER FILES - MEDICAL REPORTS
    // ============================================================
    
    match /users/{uid}/reports/{reportId}/{fileName} {
      // Read: owner, family (read-only), or authorized provider
      allow read: if canRead(uid);
      
      // Write: only owner or authorized provider
      allow write: if canWrite(uid) && isValidSize() && isValidFileType();
      
      // Delete: only owner
      allow delete: if isOwner(uid);
    }
    
    // ============================================================
    // USER FILES - CHAT UPLOADS (if any)
    // ============================================================
    
    match /users/{uid}/chat_uploads/{fileId} {
      // Chat files are private - only owner
      allow read: if isOwner(uid);
      allow write: if isOwner(uid) && isValidSize() && isValidFileType();
      allow delete: if isOwner(uid);
    }
    
    // ============================================================
    // USER FILES - PROFILE IMAGES
    // ============================================================
    
    match /users/{uid}/profile/{fileName} {
      // Profile images can be read by anyone with access to user data
      allow read: if canRead(uid);
      
      // Only owner can upload profile image
      allow write: if isOwner(uid) && 
                      isValidSize() && 
                      (request.resource.contentType.matches('image/jpeg') ||
                       request.resource.contentType.matches('image/png'));
      
      allow delete: if isOwner(uid);
    }
    
    // ============================================================
    // LEGACY PATH SUPPORT (for backward compatibility)
    // ============================================================
    
    match /reports/{uid}/{reportId}.{extension} {
      allow read: if canRead(uid);
      allow write: if canWrite(uid) && isValidSize() && isValidFileType();
      allow delete: if isOwner(uid);
    }
    
    // ============================================================
    // BLOCK ALL OTHER PATHS
    // ============================================================
    
    // Deny all other file access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
